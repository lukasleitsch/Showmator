var express=require("express"),app=express(),server=require("http").createServer(app),io=require("socket.io").listen(server,{log:!1}),sqlite3=require("sqlite3").verbose(),sanitizer=require("sanitizer"),fs=require("fs"),file="data.db";fs.existsSync(file)||(console.log("Creating DB file."),fs.openSync(file,"w")),server.listen(63123);var db=new sqlite3.Database(file),render404=function(e){e.writeHead(404),e.write("Diese Shownotes existieren nicht."),e.end()};db.serialize(function(){db.run("CREATE TABLE IF NOT EXISTS meta (slug TEXT PRIMARY KEY NOT NULL, startTime INTEGER, offset INTEGER, publicSlug TEXT, title TEXT)"),db.run("CREATE TABLE IF NOT EXISTS data (id INTEGER PRIMARY KEY AUTOINCREMENT, slug TEXT NOT NULL, title TEXT, url TEXT, time INTEGER, isText INTEGER, FOREIGN KEY (slug) REFERENCES meta(slug))"),db.run("PRAGMA foreign_keys = ON")}),io.sockets.on("connection",function(e){var t=function(){var t=[i(),e.id];for(var n in arguments)t.push(arguments[n]);console.log.apply(void 0,t)},i=function(){var e=new Date,t=function(e){return 10>e?"0"+e:e};return t(e.getDate())+"."+t(e.getMonth()+1)+"."+e.getUTCFullYear()+" - "+e.toLocaleTimeString()},n=new sqlite3.Database(file),s=function(i){t("genericError",i),e.emit("genericError")},u=function(i,n){t("findDuplicate",i,n),e.emit("findDuplicate",{id:n.id})};t("connected"),e.on("connectToLiveShownotes",function(i){t("connectToLiveShownotes",i),e.publicSlug=i,e.join(i)}),e.on("connectToHtmlExport",function(i){t("connectToHtmlExport",i),e.join(i)}),e.on("requestStatus",function(i){t("requestStatus",i),n.get("SELECT * FROM meta WHERE slug = ?",i.slug,function(i,n){i&&s(i);var u={};n&&(u={active:!0,publicSlug:n.publicSlug,title:n.title},e.publicSlug=n.publicSlug),e.emit("respondToStatus",u),t("respondToStatus",n?e.publicSlug:"no rows (=no slug yet)",n)})}),e.on("createNewShownotes",function(i){t("createNewShownotes",i),n.run("INSERT INTO meta (slug, publicSlug) VALUES (? , ?)",[sanitizer.escape(i.slug),sanitizer.escape(i.publicSlug)],function(){e.publicSlug=i.publicSlug,t("createdNewShownotes")})}),e.on("addLink",function(i){t("addLink",i);var l=(new Date).getTime();n.get("SELECT * FROM data WHERE url = ? AND slug = ?",[i.url,i.slug],function(o,a){return o&&s(o),a&&!a.isText?(u(i,a),void n.close()):void n.get("SELECT startTime, offset, publicSlug FROM meta WHERE slug = ?",i.slug,function(u,o){u&&s(u),null===o.startTime&&n.run("UPDATE meta SET startTime = ? WHERE slug = ?",[sanitizer.escape(l),sanitizer.escape(i.slug)]),n.run("INSERT INTO data (slug, title, url, time, isText) VALUES (?, ?, ?, ?, ?)",[sanitizer.escape(i.slug),sanitizer.escape(i.title),sanitizer.escape(i.url),parseInt(l),!!i.isText],function(u){u?s(u):(t("addLinkSucces"),e.broadcast.to(o.publicSlug).emit("push",{id:this.lastID,title:sanitizer.escape(i.title),url:i.url,isText:i.isText,time:l}),e.emit("addLinkSuccess")),n.close()})})})}),e.on("updateEntryTitle",function(i){t("updateEntryTitle",i),n.run("UPDATE data SET title = ? WHERE id = ? AND slug = ?",[sanitizer.escape(i.title),parseInt(i.id),sanitizer.escape(i.slug)],function(){n.get("SELECT publicSlug FROM meta WHERE slug = ?",i.slug,function(t,n){e.broadcast.to(n.publicSlug).emit("updateEntryTitleSuccess",{title:sanitizer.escape(i.title),id:i.id})})})}),e.on("openPopup",function(i){t("openPopup"),e.isPopup=!0,i.isText||n.get("SELECT id FROM data WHERE url = ? AND slug = ?",[i.url,i.slug],function(e,t){t&&u(i,t)})}),e.on("updateShownotesTitle",function(i){t("updateShownotesTitle",i),n.run("UPDATE meta SET title = ? WHERE slug = ? AND publicSlug = ?",[sanitizer.escape(i.title),sanitizer.escape(i.slug),sanitizer.escape(e.publicSlug)],function(){1===this.changes&&(i.publicSlug=e.publicSlug,[e.publicSlug,i.slug].forEach(function(t){e.broadcast.to(t).emit("updateShownotesTitleSuccess",{title:sanitizer.escape(i.title)})}))})}),e.on("updateOffset",function(e){t("updateOffset",e.offset),n.run("UPDATE meta SET offset = ? WHERE slug = ?",[parseInt(e.offset),sanitizer.escape(e.slug)])}),e.on("deleteEntry",function(i){t("deleteEntry",i),n.run("DELETE FROM data WHERE id = ? AND slug = ?",[parseInt(i.id),sanitizer.escape(i.slug)],function(){if(1===this.changes){var s=function(){io.sockets["in"](i.publicSlug).emit("deleteEntrySuccess",{id:i.id}),e.isPopup&&e.emit("deleteEntrySuccess",{id:i.id}),t("deleteEntrySuccess",i)};i.publicSlug?s():n.get("SELECT publicSlug FROM meta WHERE slug = ?",i.slug,function(e,t){i.publicSlug=t.publicSlug,s()})}else t("no entries found for deleteEntry",i)})}),e.on("disconnect",function(){t("disconnect",e.isPopup?"no slug (popup)":e.publicSlug),e.isPopup||n.close()})}),app.use(express["static"]("public")),app.get("/live/:publicSlug",function(e,t){var i=e.params.publicSlug;db.get("SELECT slug, title FROM meta WHERE publicSlug = ?",i,function(e,n){n?db.all("SELECT * FROM data WHERE slug = ? ORDER BY time DESC",n.slug,function(e,s){console.log(s),t.render("live.ejs",{items:s,publicSlug:i,title:n.title})}):render404(t)})}),app.get("/html/:slug",function(e,t){var i=e.params.slug;db.get("SELECT startTime, offset, title FROM meta WHERE slug = ?",i,function(e,n){n?db.all("SELECT * FROM data WHERE slug = ? ORDER BY time",i,function(e,s){t.render("html.ejs",{items:s,start:n.startTime,slug:i,offset:n.offset,title:n.title})}):render404(t)})});