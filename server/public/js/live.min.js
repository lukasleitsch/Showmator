var padZero=function(e){return 10>e?"0"+e:e},formatTime=function(e){var t=Math.floor(e/1e3),n=Math.floor(t/3600),o=Math.floor(t/60%60);return padZero(n%24)+":"+padZero(o)+":"+padZero(t%60)},formattedTimeRegex=/^(\d{2}):(\d{2}):(\d{2})$/,isFormattedTime=function(e){return formattedTimeRegex.test(e)},formattedTimeToMilliseconds=function(e){var t=e.match(formattedTimeRegex);return 1e3*(3600*parseInt(t[1])+60*parseInt(t[2])+parseInt(t[3]))},decode=function(e){return $("<div/>").html(e).text()},socketURL="http://localhost:63123",socket=io.connect(socketURL);$(function(){var e=$("body"),t=e.hasClass("page-live");if(socket.on("updateShownotesTitleSuccess",function(e){var n=e.title;!e.title&&t&&(n="Live"),$("#title").text(n)}),t){var n=6e4*(new Date).getTimezoneOffset(),o=$("#auto-open"),i=$("#result"),a,s="Live",c=document.title,r=0,l,d=function(){var e={hidden:"visibilitychange",webkitHidden:"webkitvisibilitychange",mozHidden:"mozvisibilitychange",msHidden:"msvisibilitychange"};for(l in e)if(l in document)return e[l]}(),u=function(){return document[l]},p=function(e){document.addEventListener(d,function(){u()||e()})},m=function(){var e=r>0?"("+r+") ":"";document.title=e+c};socket.on("connect",function(){socket.emit("connectToLiveShownotes",$("body").data("publicSlug"))}),socket.on("push",function(t){o.is(":checked")&&!t.isText&&window.open(t.url,"_blank");var s='<span class="time">'+formatTime(t.time-n)+"</span>";s+=t.isText?'<span class="entry-text">'+t.title+"</span>":'<a class="entry-text" href="'+t.url+'" target="_blank">'+t.title+"</a>",i.prepend('<li class="entry" id="entry-'+t.id+'">'+s+"</li>"),a&&$("#entry-"+t.id).find(".entry-text").after(a),e.removeClass("on-empty"),u()&&(r++,m())}),socket.on("updateEntryTitleSuccess",function(e){$("#entry-"+e.id).find(".entry-text").text(decode(e.title))}),socket.on("deleteEntrySuccess",function(t){$("#entry-"+t.id).remove(),e.toggleClass("on-empty",i.find("li").length<1)}),socket.on("updateShownotesTitleSuccess",function(e){c=(e.title?e.title:s)+" Shownotes",m()}),$(".time").each(function(){var e=$(this);e.text(formatTime(parseInt(e.data("time"))-n))}),localStorage&&o.prop("checked","true"==localStorage.autoOpen).on("change",function(){localStorage.autoOpen=$(this).prop("checked")}),"function"==typeof window.postMessage&&(window.postMessage({type:"showmatorAdminRequestFromPage",publicSlug:window.location.href.split("/")[4],listContainerID:i.prop("id"),socketURL:socketURL},"*"),window.addEventListener("message",function(e){e.source==window&&e.data&&"showmatorAdminResponseFromScript"==e.data.type&&(a=e.data.adminHtml)},!1)),p(function(){r=0,m()})}else{var f=$("#markup-container"),h=f.find(".time").data("time"),g=f.data("offset"),v=f.data("slug"),w=function(){f.find("li").find(".time").each(function(){var e=$(this),t=parseInt(e.data("time"))-h+g;e.text(formatTime(t))})},k=function(){var e=$("#as-ul").is(":checked"),t=$("#show-times").is(":checked"),n=$("#open-in-new-tab").is(":checked"),o=f.clone(),i=o.html().replace(/ data-time="\d+"/g,"").replace(/\n +/g,"\n").replace(/\n+/g,"\n").replace(/(^\n|\n$)/g,"");i=e?i.replace(/<(\/?)li( class="")?/g,"  <$1li").replace(/<(a|span)/g,"    <$1"):i.replace(/<\/li>/g,"<br>").replace(/<\/?(ul|li)( class="")?>\n?/g,""),t||(i=i.replace(/ *<span class="time"[^\/]+<\/span>\n/g,"")),n||(i=i.replace(/ target="_blank"/g,"")),o.remove(),$("#sourcecode").val(i),localStorage.showList=e?1:0,localStorage.showTimes=t?1:0,localStorage.openInNewTab=n?1:0};$("#as-ul, #show-times, #open-in-new-tab").change(k),$("#offset").val(formatTime(g)).keyup(function(){var e=$(this),t=$.trim(e.val());if(isFormattedTime(t)){e.removeClass("error");var n=formattedTimeToMilliseconds(t);n!=g&&(g=n,socket.emit("updateOffset",{slug:v,offset:g}),w(),k())}else e.addClass("error")}),$("#sourcecode").one("focus",function(){$(this).select().one("mouseup",function(e){e.preventDefault()})}),socket.on("connect",function(){socket.emit("connectToHtmlExport",v)}),$("#as-ul").prop("checked",1===parseInt(localStorage.showList)),$("#show-times").prop("checked",1===parseInt(localStorage.showTimes)),$("#open-in-new-tab").prop("checked",1===parseInt(localStorage.openInNewTab)),w(),k()}});